<!doctype html>



<html lang="de">



<head>



  <meta charset="utf-8" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />



  <title>Admin ¬∑ Daten verwalten</title>



  <style>



    :root{



      --bg:#0f0f10;--ink:#f2f3f5;--card:#16171b;--muted:#a7aab1;



      --line:#2b303a;--btn:#1976d2;--danger:#c62828;



    }



    *{box-sizing:border-box}



    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}



    header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#14151a;border-bottom:1px solid var(--line)}



    header .row{display:flex;gap:12px;align-items:center}



    .wrap{padding:16px}



    .row{display:flex;gap:12px;flex-wrap:wrap}



    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;flex:1 1 420px;min-width:320px}



    h2{margin:.2rem 0 .8rem}



    table{width:100%;border-collapse:separate;border-spacing:0 6px}



    th,td{font-size:13px;vertical-align:top}



    th{color:var(--muted);text-align:left}



    td.key{color:#cdd0d6}



    .muted{opacity:.6}



    .variants{font-size:12px;color:#98a0ab;margin-top:4px}



    input.map{width:100%;padding:8px;border-radius:8px;border:1px solid #3a3f4a;background:#1d1e23;color:#fff}



    .bar{display:flex;gap:8px;margin:8px 0;align-items:center;flex-wrap:wrap}



    .pill{display:inline-flex;align-items:center;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#cbd0d8;gap:6px}



    .pill input{margin:0}



    .foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}



    button{background:var(--btn);border:none;color:#fff;font-weight:700;border-radius:10px;padding:8px 12px;cursor:pointer}



    button:disabled{opacity:.6;cursor:default}



    button.danger{background:var(--danger)}



    .logout{background:#2b303a}



    .vac-form{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:14px}



    .vac-form label{display:flex;flex-direction:column;gap:4px;font-size:12px;color:var(--muted)}



    .vac-form input{background:#1d1e23;border:1px solid #3a3f4a;color:#fff;border-radius:8px;padding:6px 8px;min-width:120px}



    .vac-legend{font-size:12px;color:var(--muted);margin-top:-6px;margin-bottom:8px}



    td.actions{text-align:right}



    td.actions button{padding:6px 10px;font-size:12px}



    code{background:#1d1e23;padding:2px 6px;border-radius:6px;font-size:12px;color:#dfe1e6}



    .empty-row td{text-align:center;color:var(--muted);font-size:12px;padding:10px 0}



      label.stack{display:flex;flex-direction:column;gap:6px;font-size:13px;}



    .settings-row input[type=range]{width:100%;}



    .settings-row textarea.banner-message{width:100%;min-height:90px;background:#1d1e23;border:1px solid #3a3f4a;color:#fff;border-radius:8px;padding:8px;resize:vertical;}



    .settings-row .pill.inline{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;}



</style>



</head>



<body>



<header>



  <div>üõ†Ô∏è Admin ¬∑ Daten verwalten</div>



  <div class="row">



    <a class="pill" href="/admin/logout">Logout</a>



  </div>



</header>







<div class="wrap">



  <div class="row">



    <div class="card" id="subjects-ef">



      <h2>F√§cher EF</h2>



      <div class="bar">



        <span class="pill" id="sub-count-ef"></span>



        <span class="pill" id="sub-unmapped-ef"></span>



        <label class="pill"><input type="checkbox" id="only-unmapped-sub-ef" checked> nur offene</label>



      </div>



      <table id="sub-table-ef">



        <thead><tr><th style="width:45%">Normalisierter Schl√ºssel</th><th>Anzeige-Name</th></tr></thead>



        <tbody></tbody>



      </table>



      <div class="foot"><button id="save-sub-ef">Speichern</button></div>



    </div>







    <div class="card" id="subjects-q1">



      <h2>F√§cher Q1</h2>



      <div class="bar">



        <span class="pill" id="sub-count-q1"></span>



        <span class="pill" id="sub-unmapped-q1"></span>



        <label class="pill"><input type="checkbox" id="only-unmapped-sub-q1" checked> nur offene</label>



      </div>



      <table id="sub-table-q1">



        <thead><tr><th style="width:45%">Normalisierter Schl√ºssel</th><th>Anzeige-Name</th></tr></thead>



        <tbody></tbody>



      </table>



      <div class="foot"><button id="save-sub-q1">Speichern</button></div>



    </div>







    <div class="card" id="rooms">



      <h2>R√§ume</h2>



      <div class="bar">



        <span class="pill" id="room-count"></span>



        <span class="pill" id="room-unmapped"></span>



        <label class="pill"><input type="checkbox" id="only-unmapped-room" checked> nur offene</label>



      </div>



      <table id="room-table">



        <thead><tr><th style="width:45%">Normalisierter Schl√ºssel</th><th>Anzeige-Name (leer = ausblenden)</th></tr></thead>



        <tbody></tbody>



      </table>



      <div class="foot"><button id="save-room">Speichern</button></div>



    </div>



  </div>







  <div class="row">



    <div class="card" id="users">



      <h2>Benutzerkonten</h2>



      <div class="bar">



        <span class="pill" id="user-count"></span>



      </div>



      <table id="user-table">



        <thead>



          <tr>



            <th>Benutzername</th>



            <th style="text-align:right;">Aktion</th>



          </tr>



        </thead>



        <tbody></tbody>



      </table>



    </div>







    <div class="card" id="vacations">



      <h2>Ferien / Abwesenheiten</h2>



      <form id="vacation-form" class="vac-form">



        <label>Titel



          <input type="text" id="vac-title" required placeholder="z.‚ÄØB. Winterferien">



        </label>



        <label>Von



          <input type="date" id="vac-start" required>



        </label>



        <label>Bis



          <input type="date" id="vac-end">



        </label>



        <button type="submit">Hinzuf√ºgen</button>



      </form>



      <div class="vac-legend">Hinweis: Ohne Enddatum wird automatisch das Startdatum verwendet.</div>



      <table id="vacation-table">



        <thead>



          <tr>



            <th>Bezeichnung</th>



            <th>Zeitraum</th>



            <th style="text-align:right;">Aktion</th>



          </tr>



        </thead>



        <tbody></tbody>



      </table>



    </div>



  </div>



  <div class="row settings-row">



    <div class="card" id="settings">



      <h2>Darstellung</h2>



      <label class="stack">



        Breite Zeitspalte



        <input type="range" id="timeColWidth" min="40" max="120" value="60">



        <span id="timeColWidthValue" class="muted">60 px</span>



      </label>



      <label class="stack">



        Update-Hinweis (Text wird einmalig je Ger√§t gezeigt)



        <textarea id="bannerText" class="banner-message" placeholder="Kurze Info zum letzten Update"></textarea>



      </label>



      <label class="pill inline"><input type="checkbox" id="bannerEnabled"> Hinweis aktivieren</label>



      <p class="muted small">Wird automatisch ausgeblendet, nachdem ein Nutzer den Hinweis geschlossen hat.</p>



      <div class="foot"><button id="save-settings">Speichern</button></div>



    </div>



  </div>







  <div class="row">



    <div class="card" id="exams">



      <h2>Pr√ºfungen (manuell)</h2>



      <form id="exam-form" class="vac-form">



        <label>Fach



          <input type="text" id="exam-subject" required placeholder="z. B. E5 G3">



        </label>



        <label>Name



          <input type="text" id="exam-name" placeholder="Optional, sonst Fach">



        </label>



        <label>Stufe



          <select id="exam-grade">



            <option value="">(alle)</option>



            <option value="EF">EF</option>



            <option value="Q1">Q1</option>



            <option value="Q2">Q2</option>



          </select>



        </label>



        <label>Datum



          <input type="date" id="exam-date" required>



        </label>



        <label>Start



          <input type="time" id="exam-start" required>



        </label>



        <label>Ende



          <input type="time" id="exam-end" required>



        </label>



        <label>Klassen (Komma)



          <input type="text" id="exam-classes" placeholder="EF, Q1">



        </label>



        <label>Lehrkr√§fte (Komma)



          <input type="text" id="exam-teachers" placeholder="WEI, KEM">



        </label>



        <label>Raum(e)



          <input type="text" id="exam-room" placeholder="A-K25">



        </label>



        <label>Notiz



          <input type="text" id="exam-note" placeholder="optional">



        </label>



        <button type="submit">Hinzuf√ºgen</button>



      </form>



      <table id="exam-table">



        <thead>



          <tr>



            <th>Fach / Name</th>



            <th>Stufe</th>



            <th>Zeitraum</th>



            <th>Klassen / R√§ume</th>



            <th style="text-align:right;">Aktion</th>



          </tr>



        </thead>



        <tbody></tbody>



      </table>



    </div>



  </div>







  <div class="row">



    <div class="card" id="backup">



      <h2>Backup</h2>



      <div class="bar">



        <button id="backup-download" type="button">Backup herunterladen</button>



        <input type="file" id="backup-file" accept="application/json">



        <button id="backup-upload" type="button">Backup einspielen</button>



      </div>



      <div id="backup-status" class="muted"></div>



    </div>



  </div>







</div>







<script>



const $ = (s, r=document) => r.querySelector(s);



const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));







const state = {



  courses: {}, rooms: {},



  courses_ef: {}, courses_q1: {},



  subjects_grouped_ef: {}, subjects_grouped_q1: {}, rooms_grouped: {},



  unmapped_subjects_ef: [], unmapped_subjects_q1: [], unmapped_rooms: [],



  users: [], vacations: [], exams: [],



  settings: { timeColumnWidth: "60" }



};







const fmtDate = (iso) => {



  if (!iso) return "";



  const d = new Date(`${iso}T00:00:00`);



  return Number.isNaN(d.getTime()) ? iso : d.toLocaleDateString("de-DE");



};







const escapeHtml = (v) => String(v == null ? "" : v).replace(/[&<>"']/g, c => ({



  "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"



}[c] || c));







function rowHTML(nk, variants, currentValue, isMapped){



  const safeNk = escapeHtml(nk || "-");



  const variantsHtml = (variants || []).map(v => `<span>${escapeHtml(v)}</span>`).join(", ");



  const valueEscaped = escapeHtml(currentValue || "");



  const placeholderEscaped = escapeHtml(isMapped ? "(gemappt)" : "Anzeigename");



  return `



    <tr class="${isMapped ? "muted" : ""}">



      <td class="key">



        <code>${safeNk}</code>



        <div class="variants">${variantsHtml}</div>



      </td>



      <td><input class="map" data-nk="${safeNk}" value="${valueEscaped}" placeholder="${placeholderEscaped}"></td>



    </tr>



  `;



}







async function loadState(){



  let j;



  try {



    const r = await fetch("/api/admin/state", {cache:"no-store"});



    if (!r.ok){ alert("Nicht autorisiert."); location.href="/admin/login"; return; }



    j = await r.json();



  } catch (err){



    alert("Laden fehlgeschlagen. Bitte neu laden.");



    return;



  }



  if (!j || !j.ok){ alert((j && j.error) || "Fehler"); return; }







  state.courses = j.courses || {};



  state.courses_ef = j.courses_ef || {};



  state.courses_q1 = j.courses_q1 || {};



  state.rooms = j.rooms || {};



  state.subjects_grouped_ef = j.subjects_grouped_ef || {};



  state.subjects_grouped_q1 = j.subjects_grouped_q1 || {};



  state.rooms_grouped = j.rooms_grouped || {};



  state.unmapped_subjects_ef = j.unmapped_subjects_ef || [];



  state.unmapped_subjects_q1 = j.unmapped_subjects_q1 || [];



  state.unmapped_rooms = j.unmapped_rooms || [];



  state.users = Array.isArray(j.users) ? j.users : [];



  state.vacations = Array.isArray(j.vacations) ? j.vacations : [];



  state.exams = Array.isArray(j.exams_manual) ? j.exams_manual : [];



  state.settings = j.settings || state.settings || { timeColumnWidth: "60" };







  const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };



  setText("sub-count-ef", `${Object.keys(state.subjects_grouped_ef).length} Schl√ºssel`);



  setText("sub-count-q1", `${Object.keys(state.subjects_grouped_q1).length} Schl√ºssel`);



  setText("room-count", `${Object.keys(state.rooms_grouped).length} Schl√ºssel`);



  setText("sub-unmapped-ef", `${state.unmapped_subjects_ef.length} offen`);



  setText("sub-unmapped-q1", `${state.unmapped_subjects_q1.length} offen`);



  setText("room-unmapped", `${state.unmapped_rooms.length} offen`);



  setText("user-count", `${state.users.length} Konten`);



  const backupInfo = document.getElementById("backup-status");



  if (backupInfo){



    backupInfo.textContent = `Aktuelle Mappings: EF ${Object.keys(state.courses_ef).length}, Q1 ${Object.keys(state.courses_q1).length}`;



  }



  renderTables();



  renderUsers();



  renderVacations();



  renderExams();



  renderSettings();



}







function renderTables(){



  const renderGrade = (grade) => {



    const subTB = document.querySelector(`#sub-table-${grade} tbody`);



    if (!subTB) return;



    const onlyOpenEl = document.querySelector(`#only-unmapped-sub-${grade}`);



    const onlyOpen = onlyOpenEl ? onlyOpenEl.checked : false;



    const grouped = grade === "ef" ? state.subjects_grouped_ef : state.subjects_grouped_q1;



    const mapped = grade === "ef" ? state.courses_ef : state.courses_q1;



    subTB.innerHTML = "";



    Object.keys(grouped).sort().forEach(nk => {



      const isMapped = Object.prototype.hasOwnProperty.call(mapped, nk);



      if (onlyOpen && isMapped) return;



      subTB.insertAdjacentHTML("beforeend", rowHTML(nk, grouped[nk], mapped[nk] || "", isMapped));



    });



    if (!subTB.children.length) subTB.innerHTML = `<tr class="empty-row"><td colspan="2">Alles erledigt</td></tr>`;



  };



  renderGrade("ef");



  renderGrade("q1");



  const onlyOpenRmEl = $("#only-unmapped-room");



  const onlyOpenRm = onlyOpenRmEl ? onlyOpenRmEl.checked : false;



  const rmTB = $("#room-table tbody");



  if (rmTB){



    rmTB.innerHTML = "";



    Object.keys(state.rooms_grouped).sort().forEach(nk=>{



      const isMapped = Object.prototype.hasOwnProperty.call(state.rooms, nk);



      if (onlyOpenRm && isMapped) return;



      rmTB.insertAdjacentHTML(



        "beforeend",



        rowHTML(nk, state.rooms_grouped[nk], state.rooms[nk] || "", isMapped)



      );



    });



    if (!rmTB.children.length) rmTB.innerHTML = `<tr class="empty-row"><td colspan="2">Alles erledigt</td></tr>`;



  }



}







function renderUsers(){



  const tbody = $("#user-table tbody");



  tbody.innerHTML = "";



  if (!state.users.length){



    tbody.innerHTML = `<tr class="empty-row"><td colspan="2">Noch keine Benutzer angelegt.</td></tr>`;



    return;



  }



  state.users.forEach(user => {



    const tr = document.createElement("tr");



    tr.innerHTML = `



      <td>${user.username}</td>



      <td class="actions"><button class="danger" data-user="${user.id}">L√∂schen</button></td>



    `;



    tbody.appendChild(tr);



  });



}







function renderVacations(){



  const tbody = $("#vacation-table tbody");



  tbody.innerHTML = "";



  if (!state.vacations.length){



    tbody.innerHTML = `<tr class="empty-row"><td colspan="3">Keine Ferien hinterlegt.</td></tr>`;



    return;



  }



  state.vacations.forEach(v => {



    const tr = document.createElement("tr");



    const range = v.start_date === v.end_date



      ? fmtDate(v.start_date)



      : `${fmtDate(v.start_date)} ‚Äì ${fmtDate(v.end_date)}`;



    tr.innerHTML = `



      <td>${v.title}</td>



      <td>${range}</td>



      <td class="actions"><button class="danger" data-vac="${v.id}">L√∂schen</button></td>



    `;



    tbody.appendChild(tr);



  });



}







const parseList = (s) => String(s || "").split(",").map(v => v.trim()).filter(Boolean);







function renderExams(){

  const tbody = $("#exam-table tbody");

  if (!tbody) return;

  tbody.innerHTML = "";

  if (!state.exams.length){

    tbody.innerHTML = `<tr class="empty-row"><td colspan="5">Keine Eintr?ge.</td></tr>`;

    return;

  }

  state.exams.forEach(ex => {

    const classes = Array.isArray(ex.classes) ? ex.classes.join(", ") : "";

    const rooms = ex.room || "";

    const grade = (ex.grade || "").toString().toUpperCase();

    const note = ex.note ? `<div class="muted">${escapeHtml(ex.note)}</div>` : "";

    const tr = document.createElement("tr");

    tr.innerHTML = `

      <td>

        <strong>${escapeHtml(ex.name || ex.subject)}</strong>

        <div class="muted">${escapeHtml(ex.subject || "")}</div>

      </td>

      <td>${escapeHtml(grade || "-")}</td>

      <td>

        <div>${escapeHtml(fmtDate(ex.date))}</div>

        <div class="muted">${escapeHtml(ex.start || "")} - ${escapeHtml(ex.end || "")}</div>

      </td>

      <td>

        ${classes ? `<div>${escapeHtml(classes)}</div>` : ""}

        ${rooms ? `<div class="muted">${escapeHtml(rooms)}</div>` : ""}

        ${note}

      </td>

      <td class="actions"><button class="danger btn-del-exam" data-id="${escapeHtml(ex.id || "")}">L?schen</button></td>

    `;

    tbody.appendChild(tr);

  });

  $$(".btn-del-exam").forEach(btn => {

    btn.addEventListener("click", async () => {

      const rawId = btn.getAttribute("data-id") || "";

      const numId = parseInt(rawId.replace(/\D+/g, ""), 10);

      if (!Number.isFinite(numId)) return;

      if (!confirm("Eintrag wirklich l?schen?")) return;

      const r = await fetch(`/api/admin/exams/${numId}`, {method:"DELETE"});

      if (r.ok){

        await loadState();

      } else {

        alert("Konnte nicht l?schen.");

      }

    });

  });

}

function renderSettings(){



  const slider = document.getElementById("timeColWidth");



  const label = document.getElementById("timeColWidthValue");



  const bannerText = document.getElementById("bannerText");



  const bannerEnabled = document.getElementById("bannerEnabled");



  if (!slider || !label) return;



  const raw = state.settings && state.settings.timeColumnWidth ? state.settings.timeColumnWidth : "60";



  const display = String(raw);



  slider.value = display;



  label.textContent = `${display} px`;



  if (bannerText) bannerText.value = (state.settings && state.settings.updateBannerText) || "";



  if (bannerEnabled) {



    const enabledRaw = (state.settings && state.settings.updateBannerEnabled) || "0";



    bannerEnabled.checked = String(enabledRaw).trim().toLowerCase() === "1" || String(enabledRaw).trim().toLowerCase() === "true";



  }



}







async function save(kind){



  const tableId = kind === "courses_ef" ? "sub-table-ef" : kind === "courses_q1" ? "sub-table-q1" : "room-table";



  const inputs = $$("#"+tableId+" input.map");



  const out = {};



  for (const inp of inputs) out[inp.dataset.nk] = inp.value;



  const r = await fetch("/api/admin/save", {



    method: "POST",



    headers: {"content-type":"application/json"},



    body: JSON.stringify({ [kind]: out })



  });



  const j = await r.json();



  if (j.ok) { alert("Gespeichert."); loadState(); }



  else { alert(j.error||"Fehler beim Speichern"); }



}







const btnSaveEf = document.getElementById("save-sub-ef");



const btnSaveQ1 = document.getElementById("save-sub-q1");



const btnSaveRm = document.getElementById("save-room");



if (btnSaveEf) btnSaveEf.onclick = () => save("courses_ef");



if (btnSaveQ1) btnSaveQ1.onclick = () => save("courses_q1");



if (btnSaveRm) btnSaveRm.onclick = () => save("rooms");



const chkOpenEf = document.getElementById("only-unmapped-sub-ef");



const chkOpenQ1 = document.getElementById("only-unmapped-sub-q1");



const chkOpenRm = document.getElementById("only-unmapped-room");



if (chkOpenEf) chkOpenEf.onchange = renderTables;



if (chkOpenQ1) chkOpenQ1.onchange = renderTables;



if (chkOpenRm) chkOpenRm.onchange = renderTables;







const userTable = document.getElementById("user-table");



if (userTable) userTable.addEventListener("click", async (ev) => {



  const btn = ev.target.closest("button[data-user]");



  if (!btn) return;



  const userId = Number.parseInt(btn.dataset.user, 10);



  if (!Number.isFinite(userId)) return;



  const row = btn.closest("tr");



  const usernameCell = row && row.children && row.children[0];



  const username = usernameCell && usernameCell.textContent ? usernameCell.textContent.trim() : "";



  if (!confirm(`Benutzer ‚Äû${username || userId}‚Äú wirklich l√∂schen?`)) return;



  btn.disabled = true;



  try {



    const res = await fetch(`/api/admin/users/${userId}`, { method: "DELETE" });



    const j = await res.json().catch(()=>({}));



    if (!res.ok || !j.ok) alert(j.error || "L√∂schen fehlgeschlagen.");



    else loadState();



  } catch {



    alert("Netzwerkfehler beim L√∂schen.");



  } finally {



    btn.disabled = false;



  }



});







const vacationTable = document.getElementById("vacation-table");



if (vacationTable) vacationTable.addEventListener("click", async (ev) => {



  const btn = ev.target.closest("button[data-vac]");



  if (!btn) return;



  const vacId = Number.parseInt(btn.dataset.vac, 10);



  if (!Number.isFinite(vacId)) return;



  const vacRow = btn.closest("tr");



  const nameCell = vacRow && vacRow.children && vacRow.children[0];



  const name = nameCell && nameCell.textContent ? nameCell.textContent.trim() : "";



  if (!confirm(`Ferien ‚Äû${name || vacId}‚Äú wirklich l√∂schen?`)) return;



  btn.disabled = true;



  try {



    const res = await fetch(`/api/admin/vacations/${vacId}`, { method: "DELETE" });



    const j = await res.json().catch(()=>({}));



    if (!res.ok || !j.ok) alert(j.error || "L√∂schen fehlgeschlagen.");



    else loadState();



  } catch {



    alert("Netzwerkfehler beim L√∂schen.");



  } finally {



    btn.disabled = false;



  }



});







const vacForm = $("#vacation-form");



if (vacForm) vacForm.addEventListener("submit", async (ev) => {



  ev.preventDefault();



  const titleInput = document.getElementById("vac-title");



  const startInput = document.getElementById("vac-start");



  const endInput = document.getElementById("vac-end");



  const title = titleInput ? titleInput.value.trim() : "";



  const start = startInput ? startInput.value : "";



  const end = endInput ? endInput.value : "";



  if (!title || !start){



    alert("Bitte Titel und Startdatum angeben.");



    return;



  }



  const btn = vacForm.querySelector("button[type='submit']");



  btn.disabled = true;



  try {



    const res = await fetch("/api/admin/vacations", {



      method: "POST",



      headers: {"content-type":"application/json"},



      body: JSON.stringify({ title, start_date: start, end_date: end })



    });



    const j = await res.json().catch(()=>({}));



    if (!res.ok || !j.ok){



      alert(j.error || "Speichern fehlgeschlagen.");



    } else {



      vacForm.reset();



      loadState();



    }



  } catch {



    alert("Netzwerkfehler beim Speichern.");



  } finally {



    btn.disabled = false;



  }



});







const examForm = $("#exam-form");
if (examForm) examForm.addEventListener("submit", async (ev) => {
  ev.preventDefault();
  const subjInp = document.getElementById("exam-subject");
  const nameInp = document.getElementById("exam-name");
  const dateInp = document.getElementById("exam-date");
  const startInp = document.getElementById("exam-start");
  const endInp = document.getElementById("exam-end");
  const classesInp = document.getElementById("exam-classes");
  const teachersInp = document.getElementById("exam-teachers");
  const gradeInp = document.getElementById("exam-grade");
  const roomInp = document.getElementById("exam-room");
  const noteInp = document.getElementById("exam-note");
  const payload = {
    subject: subjInp ? subjInp.value : "",
    name: nameInp ? nameInp.value : "",
    date: dateInp ? dateInp.value : "",
    start_time: startInp ? startInp.value : "",
    end_time: endInp ? endInp.value : "",
    classes: parseList(classesInp ? classesInp.value : ""),
    teachers: parseList(teachersInp ? teachersInp.value : ""),
    grade: gradeInp ? gradeInp.value : "",
    room: roomInp ? roomInp.value : "",
    note: noteInp ? noteInp.value : "",
  };
  const btn = examForm.querySelector("button[type='submit']");
  btn.disabled = true;
  try {
    const res = await fetch("/api/admin/exams", {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await res.json().catch(()=>({}));
    if (!res.ok || !j.ok){
      alert(j.error || "Speichern fehlgeschlagen.");
    } else {
      examForm.reset();
      await loadState();
    }
  } catch {
    alert("Netzwerkfehler beim Speichern.");
  } finally {
    btn.disabled = false;
  }
});
const sliderTimeCol = document.getElementById("timeColWidth");



const sliderTimeColValue = document.getElementById("timeColWidthValue");



if (sliderTimeCol && sliderTimeColValue) {



  sliderTimeCol.addEventListener("input", () => {



    sliderTimeColValue.textContent = `${sliderTimeCol.value} px`;



  });



}







const saveSettingsBtn = document.getElementById("save-settings");



if (saveSettingsBtn) {



  saveSettingsBtn.onclick = async () => {



    if (!sliderTimeCol) return;



    const raw = Number(sliderTimeCol.value);



    const width = Number.isFinite(raw) ? Math.min(120, Math.max(40, Math.round(raw))) : 70;



    const bannerTextEl = document.getElementById("bannerText");



    const bannerEnabledEl = document.getElementById("bannerEnabled");



    const bannerText = bannerTextEl ? bannerTextEl.value.trim() : "";



    const bannerEnabled = bannerEnabledEl ? bannerEnabledEl.checked : false;



    const settingsPayload = {



      timeColumnWidth: String(width),



      updateBannerText: bannerText,



      updateBannerEnabled: bannerEnabled ? "1" : "0",



    };



    saveSettingsBtn.disabled = true;



    try {



      const res = await fetch("/api/admin/save", {



        method: "POST",



        headers: {"content-type":"application/json"},



        body: JSON.stringify({ settings: settingsPayload })



      });



      const j = await res.json().catch(()=>({}));



      if (j.ok) {



        alert("Gespeichert.");



        loadState();



      } else {



        alert(j.error || "Speichern fehlgeschlagen.");



      }



    } catch {



      alert("Netzwerkfehler beim Speichern.");



    } finally {



      saveSettingsBtn.disabled = false;



    }



  };



}







const backupFileInput = document.getElementById("backup-file");



const backupDownloadBtn = document.getElementById("backup-download");



const backupUploadBtn = document.getElementById("backup-upload");



const backupStatus = document.getElementById("backup-status");



const setBackupStatus = (msg) => { if (backupStatus) backupStatus.textContent = msg || ""; };







if (backupDownloadBtn) backupDownloadBtn.addEventListener("click", async () => {



  backupDownloadBtn.disabled = true;



  setBackupStatus("Backup wird erstellt...");



  try {



    const res = await fetch("/api/admin/backup", { cache: "no-store" });



    if (!res.ok) throw new Error("Download fehlgeschlagen.");



    const blob = await res.blob();



    const name = `untis-backup-${new Date().toISOString().replace(/[:.]/g,"-")}.json`;



    const url = URL.createObjectURL(blob);



    const a = document.createElement("a");



    a.href = url;



    a.download = name;



    a.style.display = "none";



    document.body.appendChild(a);



    a.click();



    document.body.removeChild(a);



    URL.revokeObjectURL(url);



    setBackupStatus("Backup gespeichert.");



  } catch (err) {



    const msg = err && err.message ? err.message : "Backup-Download fehlgeschlagen.";



    alert(msg);



    setBackupStatus("Backup-Download fehlgeschlagen.");



  } finally {



    backupDownloadBtn.disabled = false;



  }



});







if (backupUploadBtn) backupUploadBtn.addEventListener("click", async () => {



  const file = backupFileInput && backupFileInput.files ? backupFileInput.files[0] : null;



  if (!file){



    alert("Bitte eine Backup-Datei ausw√§hlen.");



    return;



  }



  let parsed;



  try {



    const text = await file.text();



    parsed = JSON.parse(text);



  } catch {



    alert("Die Datei ist kein g√ºltiges JSON.");



    return;



  }



  if (!confirm("Alle vorhandenen Daten werden ersetzt. Fortfahren?")) return;



  backupUploadBtn.disabled = true;



  setBackupStatus("Backup wird eingespielt...");



  try {



    const res = await fetch("/api/admin/restore", {



      method: "POST",



      headers: {"content-type":"application/json"},



      body: JSON.stringify(parsed)



    });



    const j = await res.json().catch(()=>({}));



    if (!res.ok || !j.ok){



      throw new Error(j.error || "Import fehlgeschlagen.");



    }



    setBackupStatus("Backup importiert.");



    if (backupFileInput) backupFileInput.value = "";



    loadState();



  } catch (err) {



    const msg = err && err.message ? err.message : "Backup-Import fehlgeschlagen.";



    alert(msg);



    setBackupStatus("Backup-Import fehlgeschlagen.");



  } finally {



    backupUploadBtn.disabled = false;



  }



});







loadState();



</script>



</body>



</html>



